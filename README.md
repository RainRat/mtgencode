# Magic: The Gathering Card Encoder (mtgencode)

This tool helps you convert Magic: The Gathering card data into a format that AI models can read and learn from. It also converts the AI's output back into readable card text or visual spoilers.

**What this is for:**
*   **Machine Learning:** preparing data to train Neural Networks (like RNNs or Transformers) to generate new Magic cards.
*   **Decoding:** Turning the raw text generated by an AI back into readable cards or [Magic Set Editor](http://magicseteditor.boards.net) files.

---

## Installation

You can run this project using Docker (easier) or install it directly on your computer.

### Option 1: Docker (Recommended)
This method handles all dependencies for you.

*   **Linux/macOS:** Run `./docker-interactive.sh`
*   **Windows:** Run `./docker-interactive.bat`

### Option 2: Local Installation
If you prefer to run it directly on your machine:

1.  **Check Prerequisites:**
    Ensure you have Python 3.9 or newer installed.
    ```bash
    python3 --version
    ```

2.  **Get the Code:**
    ```bash
    git clone https://github.com/billzorn/mtgencode.git
    cd mtgencode
    ```

3.  **Install Libraries:**
    ```bash
    python3 -m pip install -r requirements.txt
    ```

4.  **Download Language Data:**
    This tool uses NLTK for text processing. Run this command to download the necessary data:
    ```bash
    python3 -m nltk.downloader punkt punkt_tab
    ```

---

## Quick Start Guide

### 0. Verify Installation (Recommended)
You can verify that everything is set up correctly by running a quick test using the included sample data. This command encodes a sample card and then decodes it back into readable text:

```bash
python3 encode.py testdata/uthros.json | python3 decode.py
```

### 1. Get the Data
Download card data from [MTGJSON](https://mtgjson.com/downloads/all-files/). We recommend `AllPrintings.json` for a complete dataset, but you can also use smaller files (like `Standard.json` or `Vintage.json`) for faster testing.

Create a `data/` folder and place your downloaded JSON file there:

```bash
# Create the directory
mkdir -p data
# Move your downloaded file into the data/ folder
# (Example: mv ~/Downloads/AllPrintings.json data/)
```

### 2. Encode Cards (JSON -> Text)
Convert the JSON data into a simple text format for AI training.

```bash
# Basic encoding
python3 encode.py data/AllPrintings.json encoded_output.txt --verbose
```
*   **Input:** `data/AllPrintings.json`
*   **Output:** `encoded_output.txt` (A text file with one card per entry)

### 3. Decode Cards (Text -> Readable)
Convert encoded text back into a readable format. You can print the results to your terminal or save them to a file.

```bash
# View decoded cards in your terminal
python3 decode.py encoded_output.txt

# Save to a file (the format is automatically detected from the file extension)
python3 decode.py encoded_output.txt my_cards.html
```

**Want to see visual spoilers?**
Generate a file for [Magic Set Editor](https://magicseteditor.boards.net/):
```bash
python3 decode.py encoded_output.txt my_set.mse-set
```
*   **Note:** Double-click the `.mse-set` file to open it in Magic Set Editor.

---

## Usage Details

### `encode.py` (Preparing Data)
Options to customize how the data is formatted:
*   `--encoding std`: Standard format (Name comes last). Default.
*   `--encoding named`: Name comes first.
*   `--encoding old`: Legacy format (Name comes first).
*   `--encoding vec`: Vectorized format (numbers representing words) for specific model types.
*   `--randomize`: Randomizes mana symbol order (e.g., `{U}{W}` vs `{W}{U}`) to help the AI generalize.

### `decode.py` (Viewing Results)
Options for formatting the output:
*   `--gatherer`: Formats text like the official Gatherer website (Default).
*   `--raw`: Disables Gatherer formatting and shows raw text.
*   `--html`: Creates a webpage with card images.
*   `--mse`: Creates a set file for Magic Set Editor.
*   `--json`: Creates a structured JSON file.
*   `--csv`: Creates a CSV file for spreadsheets.
*   `--md`: Creates a Markdown file.

> **Important:** If you used a specific encoding (like `named`) when running `encode.py`, you **must** use that same encoding flag when running `decode.py`.
>
> ```bash
> # Example: If you encoded with 'named'
> python3 encode.py data/AllPrintings.json output.txt -e named
> # You must decode with 'named'
> python3 decode.py output.txt -e named
> ```

**Automatic Format Detection:**
If you provide an output filename, the tool automatically selects the format based on its extension:
*   `.html` -> HTML webpage
*   `.json` -> JSON data
*   `.csv`  -> CSV spreadsheet
*   `.md`   -> Markdown document
*   `.sum`, `.summary` -> Compact one-line summary
*   `.mse-set` -> Magic Set Editor file

### Power User Tip: Piping
The tools in this project are designed to work together using "pipes" (`|`). This allows you to process cards in a single step without creating temporary files.

```bash
# Encode 10 cards and view them immediately
python3 encode.py data/AllPrintings.json --limit 10 | python3 decode.py

# Encode, sort, and save to a file
python3 encode.py data/AllPrintings.json --limit 100 | python3 sortcards.py - sorted_cards.txt
```
*   **Note:** Use a hyphen (`-`) as the filename to tell a script to read from standard input.

### `sortcards.py` (Organizing Output)
Organizes encoded cards into categories (like Color, Card Type, etc.) and wraps them in `[spoiler]` tags. This is useful for posting generated cards on forums.

```bash
python3 sortcards.py encoded_output.txt sorted_output.txt
```
*   **Note:** If your input file was not encoded using the default `std` format, use the `-e` flag to specify the correct encoding (e.g., `python3 sortcards.py ... -e named`).

### Training a Neural Network
*Note: This tool prepares the data. It does not train the model itself.*

1.  **Encode:** Use `encode.py` to create `input.txt`.
2.  **Train:** Use a tool like `mtg-rnn`, `char-rnn`, or a Transformer model on `input.txt`.
3.  **Generate:** Have your model produce text.
4.  **Decode:** Use `decode.py` to turn that text into cards.

---

## Troubleshooting

*   **Missing NLTK Data:** If you see an error about `punkt` or `punkt_tab` not found, run the download command from the Installation section.
*   **File Not Found:** If you get an error when running `encode.py`, check that `data/AllPrintings.json` exists and the path is correct.
*   **MSE Symbols Missing:** If your generated cards show squares instead of symbols, you are missing the required Magic fonts (Beleren, Relay, MPlantin). See [DEPENDENCIES.md](DEPENDENCIES.md) for help.

---

## Advanced Tools & Debugging

We provide extra tools in the `scripts/` folder to help you manage your data.

### Reporting Errors
If some cards fail to process, you can save them to a file for review:
*   **When Encoding:** Use `--report-unparsed <filename>` to save cards that the tool could not understand.
*   **When Decoding:** Use `--report-failed <filename>` to save cards that were formatted incorrectly.

### Extracting One Card
The main Magic data file (`AllPrintings.json`) is very large. To test a specific card without loading everything, you can extract it to a small file:
```bash
python3 scripts/extract_one.py data/AllPrintings.json SET_CODE "Card Name"
```

### Checking Your Data
Use `summarize.py` to see statistics about your encoded cards, such as the distribution of card types and colors:
```bash
python3 scripts/summarize.py encoded_output.txt
```

---

## Documentation & Help
*   [DEPENDENCIES.md](DEPENDENCIES.md): How to set up external tools like Magic Set Editor.
*   [CUSTOM.md](CUSTOM.md): How to integrate your own custom cards.
*   [AGENTS.md](AGENTS.md): Information for AI agents.
*   To run tests: `python3 -m pytest`
